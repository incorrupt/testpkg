name: Upgrade NPM dependencies

on:
  push:
  schedule:
    # At 00:00 on Monday
    - cron: '0 0 * * 1'

jobs:
  # Upgrade in two ways:
  # - soft: only upgrade dependencies constrained by the versions specified in package.json
  # - hard: upgrade all dependencies to their latest versions
  upgrade:
    name: Upgrade dependencies
    runs-on: ubuntu-latest
    outputs:
      soft: ${{ steps.git-check-soft.outputs.modified }}
      hard: ${{ steps.git-check-hard.outputs.modified }}
    steps:
      - name: Checkout code
        uses: actions/checkout@master
        with:
          ref: ${{ github.head_ref }}

      - name: Setup NodeJS environment
        uses: actions/setup-node@v1
        with:
          node-version: 12

      - name: Soft upgrade
        run: yarn upgrade

      - name: Check for modified files
        id: git-check-soft
        run: echo ::set-output name=modified::$(if git diff-index --quiet HEAD --; then echo "false"; else echo "true"; fi)

      - name: Save soft upgrade state
        if: ${{ steps.git-check-soft.outputs.modified == 'true' }}
        run: mkdir .soft-upgrade && cp yarn.lock .soft-upgrade/yarn.lock && cp package.json .soft-upgrade/package.json

      - name: Upload soft upgrade state
        if: ${{ steps.git-check-soft.outputs.modified == 'true' }}
        uses: actions/upload-artifact@v2
        with:
          name: soft-upgrade
          path: .soft-upgrade

      - name: Hard upgrade
        id: hard-upgrade
        continue-on-error: true
        run: yarn upgrade --latest

      - name: Check for modified files
        if: ${{ steps.hard-upgrade.outcome != 'failure' }}
        id: git-check-hard
        run: echo ::set-output name=modified::$(if git diff-index --quiet HEAD --; then echo "false"; else echo "true"; fi)

      - name: Save hard upgrade state
        if: ${{ steps.hard-upgrade.outcome != 'failure' && steps.git-check-hard.outputs.modified == 'true'}}
        run: mkdir .hard-upgrade && cp yarn.lock .hard-upgrade/yarn.lock && cp package.json .hard-upgrade/package.json

      - name: Upload hard upgrade state
        if: ${{ steps.hard-upgrade.outcome != 'failure' && steps.git-check-hard.outputs.modified == 'true'}}
        uses: actions/upload-artifact@v2
        with:
          name: hard-upgrade
          path: .hard-upgrade

  # Test hard upgrade
  hardtest:
    name: Test hard upgrade
    needs: [upgrade]
    if: ${{ needs.upgrade.outputs.hard == 'true' }}
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@master
        with:
          ref: ${{ github.head_ref }}

      - name: Setup NodeJS environment
        uses: actions/setup-node@v1
        with:
          node-version: 12

      - name: Download hard upgrade state
        uses: actions/download-artifact@v2
        with:
          name: hard-upgrade

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run tests
        run: yarn testo

  # Fallback to testing soft upgrade if hard upgrade testing failed
  softtest:
    name: Test soft upgrade
    needs: [upgrade, hardtest]
    if: ${{ needs.hardtest.outcome != 'success' && needs.upgrade.outputs.soft == 'true' }}
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@master
        with:
          ref: ${{ github.head_ref }}

      - name: Setup NodeJS environment
        uses: actions/setup-node@v1
        with:
          node-version: 12

      - name: Download soft upgrade state
        uses: actions/download-artifact@v2
        with:
          name: soft-upgrade

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run tests
        run: yarn test

  # Commit changes if upgrade was successful
  commit:
    name: Commit changes
    needs: [hardtest, softtest]
    if: ${{ needs.hardtest.outcome == 'success' || needs.softtest.outcome == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@master
        with:
          ref: ${{ github.head_ref }}

      - name: Download soft upgrade state
        if: ${{ needs.softtest.outcome == 'success' }}
        uses: actions/download-artifact@v2
        with:
          name: soft-upgrade

      - name: Download hard upgrade state
        if: ${{ needs.hardtest.outcome == 'success' }}
        uses: actions/download-artifact@v2
        with:
          name: hard-upgrade

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v2
        with:
          branch: upgrade-dependencies-${{github.ref}}
          commit-message: Upgrade dependencies
          title: Changes by Upgrade action workflow
          labels: automerge, dependencies

      - name: Merge Pull Request
        uses: actions/github-script@master
        if: ${{ steps.cpr.outputs.pull-request-number > 0 }}
        env:
          pr_number: ${{ steps.cpr.outputs.pull-request-number }}
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: process.env['pr_number']
            })
